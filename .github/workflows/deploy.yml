name: Deploy to Cloudflare Pages

on:
    push:
        branches:
            - main
    repository_dispatch: # 监听内容仓库的更新信号
        types:
            - content-updated # 必须与内容仓库发送的 event-type 一致
    workflow_dispatch: # 支持手动触发

jobs:
    deploy:
        runs-on: ubuntu-latest
        permissions:
            contents: read
            deployments: write
        steps:
            - name: Checkout code repository
              uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "lts/*"

            - name: Setup pnpm
              uses: pnpm/action-setup@v4
              with:
                  run_install: false

            - name: Install dependencies
              run: pnpm install --frozen-lockfile

            - name: Sync content from content repository
              run: pnpm run sync-content
              env:
                  ENABLE_CONTENT_SYNC: true
                  CONTENT_REPO_URL: https://github.com/L-1ngg/Mizuki-Content.git

            - name: Build site
              run: pnpm run build

            - name: Deploy to Cloudflare Pages
              uses: cloudflare/pages-action@v1
              with:
                  apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
                  accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
                  projectName: mizuki # 你的 Cloudflare Pages 项目名称
                  directory: dist # Astro 构建输出目录
                  gitHubToken: ${{ secrets.GITHUB_TOKEN }}
                  branch: main # 部署分支
